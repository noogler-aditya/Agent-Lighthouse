name: CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  frontend:
    name: Frontend Lint + Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Test
        run: npm run test

      - name: Audit production dependencies
        run: npm audit --omit=dev --audit-level=high

  backend:
    name: Backend Quality + Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Install backend dependencies
        run: pip install -r backend/requirements-dev.txt

      - name: Compile backend sources
        run: python -m compileall backend

      - name: Ruff checks
        run: ruff check backend --select E9,F63,F7,F82

      - name: Bandit security scan
        run: bandit -q -r backend -x backend/tests,backend/integration_tests

      - name: Backend tests
        run: pytest -q backend/tests

      - name: Import app
        env:
          JWT_SECRET: ci-jwt-secret
          MACHINE_API_KEYS: "ci-key:trace:write|trace:read"
          ALLOWED_ORIGINS: http://localhost:5173
          REDIS_URL: redis://localhost:6379
        run: PYTHONPATH=backend python -c "from main import app; print(app.title)"

  sdk:
    name: SDK Checks (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: sdk/pyproject.toml

      - name: Install SDK
        run: pip install -e "sdk[dev]"

      - name: Compile SDK sources
        run: python -m compileall sdk

      - name: Ruff checks
        run: ruff check sdk/agent_lighthouse --select E9,F63,F7,F82

      - name: Bandit security scan
        run: bandit -q -r sdk/agent_lighthouse -x sdk/tests

      - name: SDK tests
        run: pytest -q sdk/tests

      - name: Import SDK and tracer
        run: |
          python - <<'PY'
          from agent_lighthouse import get_tracer, LighthouseClient, LighthouseTracer
          tracer = get_tracer(base_url="http://localhost:8000", api_key="ci-key")
          assert tracer is not None
          assert isinstance(tracer, LighthouseTracer)
          assert isinstance(tracer.client, LighthouseClient)
          print("SDK import and tracer checks passed")
          PY

  integration:
    name: Integration Smoke (Backend + Redis + SDK)
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
      postgres:
        image: postgres:16-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: lighthouse
          POSTGRES_PASSWORD: lighthouse
          POSTGRES_DB: lighthouse
        options: >-
          --health-cmd "pg_isready -U lighthouse"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            sdk/pyproject.toml

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install -e sdk

      - name: Start backend
        env:
          JWT_SECRET: ci-jwt-secret
          MACHINE_API_KEYS: "ci-key:trace:write|trace:read"
          ALLOWED_ORIGINS: http://localhost:5173
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://lighthouse:lighthouse@localhost:5432/lighthouse
        run: |
          nohup uvicorn main:app --app-dir backend --host 127.0.0.1 --port 8000 > backend.log 2>&1 &
          echo $! > backend.pid

      - name: Wait for backend health
        run: |
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8000/health/ready > /dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Backend failed to become healthy"
          cat backend.log
          exit 1

      - name: Verify auth behavior
        run: |
          set -e
          code_without_auth=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/api/traces)
          test "$code_without_auth" = "401"

          viewer_token=$(curl -s http://127.0.0.1:8000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"username":"ci-user","password":"ci-pass"}' | python -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
          code_with_bearer=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${viewer_token}" http://127.0.0.1:8000/api/traces)
          test "$code_with_bearer" = "200"

          trace_id=$(curl -s -X POST http://127.0.0.1:8000/api/traces \
            -H "X-API-Key: ci-key" \
            -H "Content-Type: application/json" \
            -d '{"name":"machine-trace"}' | python -c "import sys,json; print(json.load(sys.stdin)['trace_id'])")
          state_with_machine=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "X-API-Key: ci-key" "http://127.0.0.1:8000/api/state/${trace_id}/pause")
          test "$state_with_machine" = "401"

      - name: Run smoke trace check
        env:
          LIGHTHOUSE_API_KEY: ci-key
          LIGHTHOUSE_BASE_URL: http://127.0.0.1:8000
        run: python sdk/examples/smoke_trace_check.py

      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill "$(cat backend.pid)" || true
          fi

      - name: Print backend logs on failure
        if: failure()
        run: cat backend.log

  backend-integration-redis:
    name: Backend Integration (Redis, Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
      postgres:
        image: postgres:16-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: lighthouse
          POSTGRES_PASSWORD: lighthouse
          POSTGRES_DB: lighthouse
        options: >-
          --health-cmd "pg_isready -U lighthouse"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Install backend dependencies
        run: pip install -r backend/requirements-dev.txt

      - name: Run backend integration tests
        env:
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://lighthouse:lighthouse@localhost:5432/lighthouse
          JWT_SECRET: ci-jwt-secret
          ALLOWED_ORIGINS: http://localhost:5173
        run: pytest -q backend/integration_tests

  frontend-e2e:
    name: Frontend E2E (Playwright)
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
      postgres:
        image: postgres:16-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: lighthouse
          POSTGRES_PASSWORD: lighthouse
          POSTGRES_DB: lighthouse
        options: >-
          --health-cmd "pg_isready -U lighthouse"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        run: pip install -r backend/requirements.txt

      - name: Start backend
        env:
          JWT_SECRET: ci-jwt-secret
          MACHINE_API_KEYS: "ci-key:trace:write|trace:read"
          ALLOWED_ORIGINS: http://127.0.0.1:4173,http://localhost:4173
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://lighthouse:lighthouse@localhost:5432/lighthouse
        run: |
          nohup uvicorn main:app --app-dir backend --host 127.0.0.1 --port 8000 > backend-e2e.log 2>&1 &
          echo $! > backend-e2e.pid

      - name: Wait for backend readiness
        run: |
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8000/health/ready > /dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Backend failed to become ready"
          cat backend-e2e.log
          exit 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm install --prefix frontend

      - name: Install Playwright browsers
        run: npx --prefix frontend playwright install --with-deps chromium

      - name: Run frontend e2e
        run: npm run e2e --prefix frontend

      - name: Stop backend
        if: always()
        run: |
          if [ -f backend-e2e.pid ]; then
            kill "$(cat backend-e2e.pid)" || true
          fi

      - name: Print backend logs on failure
        if: failure()
        run: cat backend-e2e.log

  notify-failed-pr:
    name: Notify Failed PR
    if: >-
      ${{
        always() &&
        github.event_name == 'pull_request' &&
        (
          needs.frontend.result == 'failure' ||
          needs.backend.result == 'failure' ||
          needs.sdk.result == 'failure' ||
          needs.integration.result == 'failure' ||
          needs['backend-integration-redis'].result == 'failure' ||
          needs['frontend-e2e'].result == 'failure'
        )
      }}
    needs:
      - frontend
      - backend
      - sdk
      - integration
      - backend-integration-redis
      - frontend-e2e
    runs-on: ubuntu-latest
    steps:
      - name: Comment and label failed PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.info('No pull request found in context.');
              return;
            }

            const body = [
              "CI checks failed for this pull request.",
              "",
              "Please push fixes and CI will re-run automatically."
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ["ci-failed"]
            });
